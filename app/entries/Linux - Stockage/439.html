<div><span style="font-size: 19px;">CREATION DU TEST</span></div><div>&nbsp;&nbsp;<br></div><div>Suite à l'ajout à chaud d'un disque à la VM de 2Go, on le fait reconnaitre par l'OS :</div><div>&nbsp;&nbsp;<br></div><div>Note pour savoir quel host scanner :&nbsp;</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">echo "- - -" &gt; /sys/class/scsi_host/host2/scan</div><div>&nbsp;&nbsp;<br></div><div>Création d'un PV à partir du nouveau disque : <a href="https://www.evernote.com/shard/s72/nl/8374248/9fcfbd1f-40e3-4551-98f6-c43b6a1231c1" style="color: rgb(105, 170, 53);">Ajouter un disque VMware</a></div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">pvcreate /dev/sdb</div><div>&nbsp;&nbsp;<br></div><div>Création d'un VG avec ce nouveau PV :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">vgcreate vg_test /dev/sdb</div><div>&nbsp;&nbsp;<br></div><div>Création d'un LV dans ce VG en prenant tout le VG :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">lvcreate -n lv_test1 -l 100%FREE vg_test</div><div>&nbsp;&nbsp;<br></div><div><span style="font-weight: bold;">Note</span> : Si je voulais en créer un de 25G par exemple :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>-l X pour créer d'une taille de X physical extents (PE)</div><div>-L X pour la taille en bytes, exemple :</div><div>-L 128M = 128MiB = 128 binary megabytes (1 MiB = 1048576 bytes)</div></div><div>&nbsp;&nbsp;<br></div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">lvcreate -n lv_test1 -L 25G vg_test</div><div>&nbsp;&nbsp;<br></div><div>Formatage du LV en ext4 :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">mkfs -t ext4 /dev/vg_test/lv_test1</div><div>&nbsp;&nbsp;<br></div><div>Création du point de montage pour ce FS</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">mkdir /test</div><div>&nbsp;&nbsp;<br></div><div>Montage du FS :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">mount /dev/vg_test/lv_test1 /test</div><div>&nbsp;&nbsp;<br></div><div><span style="font-weight: bold;">Note</span> : Si besoin, le faire monter automatiquement dans la fstab en créant la ligne.</div><div>&nbsp;&nbsp;<br></div><div>Création d'un fichier de 100 Mo sur ce FS pour tester qu'après réduction le fichier est toujours là :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>cd /test/</div><div>dd if=/dev/urandom of=/test/100Mo.random bs=1KB count=100000</div></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 19px;">REDUCTION</span></div><div>&nbsp;&nbsp;<br></div><div>Vérification qu'aucun process n'utilise ce FS (il faut demander aux équipes applicatives d'arrêter leurs applis et bdd pour pouvoir démonter le FS) :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">lsof /test/</div><div>&nbsp;&nbsp;<br></div><div>ou bien,</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>fuser /test</div><div>fuser -c /test &nbsp; ---&gt; voir la différence ??</div></div><div>&nbsp;&nbsp;<br></div><div>Démontage du FS :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">umount /test/</div><div>&nbsp;&nbsp;<br></div><div>Vérification qu'il est bien démonté :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">mount</div><div>&nbsp;&nbsp;<br></div><div>Vérification du FS :</div><div>&nbsp;&nbsp;<br></div><div>-f = force le check même si les critères disent que le FS est clean</div><div>-y = répond oui automatiquement pour toutes les demandes de réparations</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">fsck -fvy /dev/vg_test/lv_test1</div><div>&nbsp;&nbsp;<br></div><div>Réduction du FS (2G à 500M) :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">resize2fs /dev/vg_test/lv_test1 500M</div><div>&nbsp;&nbsp;<br></div><div>Réduction du LV (2G à 600M car il faut prendre de la marge pour être sûr de ne pas écraser le FS. 5G devraient suffire. Là j'ai testé à 100M de différence pour voir) :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">lvreduce -L 600M /dev/vg_test/lv_test1</div><div>&nbsp;&nbsp;<br></div><div>---------------------- DEBUT NOTE -------------------------------------------------</div><div>&nbsp;&nbsp;<br></div><div style="border: 0px; font-size: 16px; margin: 0px 0px 24px; outline: 0px; padding: 0px; vertical-align: baseline; text-align: justify;"><span style="border: 0px; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline; color: rgb(43, 43, 43); font-family: Lato, sans-serif; font-weight: 700;">Il est très risqué de réduire un LV disposant d’un système de fichier et c’est bien pire si le file system est monté…&nbsp;</span><span style="color: rgb(43, 43, 43); font-family: Lato, sans-serif;">Si l’expérience vous tente,&nbsp;</span><span style="border: 0px; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline; color: rgb(43, 43, 43); font-family: Lato, sans-serif; font-weight: 700;">lvreduce</span><span style="color: rgb(43, 43, 43); font-family: Lato, sans-serif;">&nbsp;vous permettra d’effectuer ce type d’action :</span></div><div style="border: 1px solid silver; font-size: 16px; margin: 0px 0px 1.5em; outline: 0px; padding: 0px; vertical-align: baseline; background-color: rgb(249, 249, 249); overflow: auto hidden; width: auto; position: relative;"><div>&nbsp;&nbsp;<br></div><table style="font-size: 14px; outline: 0px; vertical-align: baseline; width: 536px;"><colgroup><col style="width: 536px;"></colgroup><tbody><tr style="outline: 0px; padding: 0px; vertical-align: baseline;"><td style="outline: 0px; background-color: rgb(238, 238, 238); border: 1px solid rgb(204, 204, 204); vertical-align: top !important;"><div style="outline: 0px; vertical-align: baseline; hyphens: none; max-width: 100%; overflow-wrap: break-word; border: none !important; margin: 0px !important; padding: 0px 4px !important; overflow: visible !important; white-space: pre !important; background: transparent !important; width: auto !important; float: none !important; clear: none !important; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px !important; border-radius: 0px !important;"><div>&nbsp;&nbsp;<br></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">19:25:28 mafalda ~ # lvreduce -L-5G /dev/test/vserver</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">WARNING: Reducing active and open logical volume to 125.00 GiB</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">THIS MAY DESTROY YOUR DATA (filesystem etc.)</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">Do you really want to reduce vserver? [y/n]: y</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">Reducing logical volume vserver to 125.00 GiB</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">Logical volume vserver successfully resized</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">19:26:24 mafalda ~ # xfs_growfs /dev/test/vserver</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">...</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">data size 32768000 too small, old size is 34078720</span></div></div></td></tr></tbody></table><div>&nbsp;&nbsp;<br></div></div><div style="border: 0px; font-size: 16px; margin: 0px 0px 24px; outline: 0px; padding: 0px; vertical-align: baseline; text-align: justify;"><span style="color: rgb(43, 43, 43); font-family: Lato, sans-serif;">Et là c’est le drame… Après démontage, impossible de remonter la partition… enfin… on y arrive quand même en forçant un peu :</span></div><div style="border: 1px solid silver; font-size: 16px; margin: 0px 0px 1.5em; outline: 0px; padding: 0px; vertical-align: baseline; background-color: rgb(249, 249, 249); overflow: auto hidden; width: auto; position: relative;"><div>&nbsp;&nbsp;<br></div><table style="font-size: 14px; outline: 0px; vertical-align: baseline; width: 472px;"><colgroup><col style="width: 472px;"></colgroup><tbody><tr style="outline: 0px; padding: 0px; vertical-align: baseline;"><td style="outline: 0px; background-color: rgb(238, 238, 238); border: 1px solid rgb(204, 204, 204); vertical-align: top !important;"><div style="outline: 0px; vertical-align: baseline; hyphens: none; max-width: 100%; border: none !important; margin: 0px !important; padding: 0px 4px !important; overflow: visible !important; background: transparent !important; width: auto !important; float: none !important; clear: none !important; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px !important; border-radius: 0px !important;"><div><span style="color: rgb(17, 0, 0); font-family: monospace;">19:27:14&nbsp;mafalda&nbsp;~&nbsp;#&nbsp; lvextend&nbsp;-L&nbsp;+5G&nbsp;/dev/test/vserver&nbsp;</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">&nbsp; Extending&nbsp;logical&nbsp;volume&nbsp;vserver&nbsp;to&nbsp;130.00&nbsp;GiB</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">&nbsp; Logical&nbsp;volume&nbsp;vserver&nbsp;successfully&nbsp;resized</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">19:29:42&nbsp;mafalda&nbsp;~&nbsp;#&nbsp;xfs_repair&nbsp;/dev/test/vserver</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">...</span></div><div><span style="color: rgb(17, 0, 0); font-family: monospace;">19:24:48&nbsp;mafalda&nbsp;~&nbsp;#&nbsp;mount&nbsp;/dev/test/vserver&nbsp;/vservers/</span></div></div></td></tr></tbody></table><div>&nbsp;&nbsp;<br></div></div><div>---------------------- FIN NOTE -------------------------------------------------</div><div>&nbsp;&nbsp;<br></div><div>&nbsp;&nbsp;<br></div><div>Agrandissement du FS à la taille du LV (on devrait repasser à 600M normalement) :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">resize2fs /dev/vg_test/lv_test1</div><div>&nbsp;&nbsp;<br></div><div>Vérification du FS :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">fsck -fyv /dev/vg_test/lv_test1</div><div>&nbsp;&nbsp;<br></div><div>Remontage du FS :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">mount /dev/vg_test/lv_test1 /test</div><div>&nbsp;&nbsp;<br></div><div>Vérification de la taille du FS :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">df -PhT</div><div>&nbsp;&nbsp;<br></div><div><span style="color: rgb(255, 0, 0);">Attention à prendre en compte !</span> Au final, le FS fait maintenant 550M, il ne fait donc pas exactement 600M.</div><div>Sur un LV de 600G, le FS fera 591G (à cause des métadata).</div><div>&nbsp;&nbsp;<br></div>