<div><div align="left" style="min-height: 13pt;"><div>Le kernel protège les FS en les passants en RO quand il voit des blocks corrompus.&nbsp;</div><div>On doit rapidement faire un FSCK de ces FS sinon il y a risque d'une corruption de données à venir.</div><div>&nbsp;<br></div><div><hr></div><div>&nbsp;<br></div></div><div>Le fsck doit être fait sur un FS <span style="color: rgb(255, 0, 0); font-weight: bold;">démonté</span>. Si on autorise à le faire sur un FS monté et que l'on autorise le fsck à faire des correction (répondre yes) ça peut provoquer de graves corruptions de données (voir un kernel panic) même si le FS est en read-only.</div><div>&nbsp;<br></div><div>fsck : la commande ne fonctionne que pour les fs EXTx (pas XFS). Cette commande est générique, elle lance la commande appropriée suivant le type de fs. Elle ²va lancer par exemple e2fsck.</div><div>&nbsp;<br></div><div><span style="text-decoration-line: underline;">Temps d'un FSCK :&nbsp;</span></div><div>&nbsp;<br></div><div>Dépend de la taille de la partition, du nombre d'erreurs rencontrées, du nombre fichiers (plus long si bcp de petits fichiers) etc... donc impossible à quantifier.</div><div>&nbsp;<br></div><hr><div>&nbsp;<br></div><div><span style="font-weight: bold;">FSCK sur NFS NAS :</span></div><div>&nbsp;<br></div><div>Pas de fsck depuis la machine cliente puisque c'est un FS que l'on exporte d'un serveur. Donc si on veut faire un FSCK d'un NAS il faut aller faire un fsck sur le FS du serveur. Logique.</div><div>&nbsp;<br></div><div><hr></div><div><span style="font-size: 19px;"><span style="font-weight: bold;">&nbsp;<br></span></span></div><div><span style="font-size: 19px;"><span style="font-weight: bold;">Centos 7 (FS en xfs)</span></span></div><div>&nbsp;<br></div><div><span style="font-weight: bold;">Note</span> : tune2fs ne fonctionne qu'avec des FS en EXT.</div><div>&nbsp;<br></div><div>Le man de "fsck.xfs" indique qu'il n'est pas nécessaire de fschecker un FS en XFS. Il se corrige tout seul à chaque montage (donc aussi à chaque reboot).</div><div>Mais le man indique qu'il est possible de fschecker avec xfs_repair.</div><div>&nbsp;<br></div><table style="table-layout: fixed; width: 596px;-evernote-table:true;"><colgroup><col style="width: 596px;"></colgroup><tbody><tr><td style="border: 1px solid rgb(211, 211, 211);"><div>fsck.xfs&nbsp; is&nbsp; called by the generic Linux fsck(8) program at startup to check and repair an XFS filesystem.&nbsp; XFS is a journaling filesystem and performs recovery at mount(8) time if necessary, so fsck.xfs simply exits with a</div><div>&nbsp; &nbsp; &nbsp; &nbsp;zero exit status.</div><div>&nbsp;<br></div><div>&nbsp; &nbsp; &nbsp; &nbsp;If you wish to check the consistency of an XFS filesystem, or repair a damaged or corrupt XFS filesystem, see xfs_repair(8).</div></td></tr></tbody></table><div>&nbsp;<br></div><div>DOC RHEL&nbsp; - 3.5. REPAIRING AN XFS FILE SYSTEM</div><div><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/xfsrepair">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/xfsrepair</a></div><div>&nbsp;<br></div><div>To repair an XFS file system, use xfs_repair:</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"># xfs_repair /dev/device</div><div>&nbsp;<br></div><div>The xfs_repair utility is highly scalable and is designed to repair even very large file systems with many inodes efficiently. Unlike other Linux file systems, xfs_repair does not run at boot time, even when an XFS file system was not cleanly unmounted. In the event of an unclean unmount, xfs_repair simply replays the log at mount time, ensuring a consistent file system.</div><div>&nbsp;<br></div><div><span style="color: rgb(255, 0, 0);">Warning</span></div><div>The xfs_repair utility cannot repair an XFS file system with a dirty log. To clear the log, mount and unmount the XFS file system. If the log is corrupt and cannot be replayed, use the -L option ("force log zeroing") to clear the log, that is, xfs_repair -L /dev/device. Be aware that this may result in further corruption or data loss.</div><div>&nbsp;<br></div><div>For more information about repairing an XFS file system, see man xfs_repair.</div><div>&nbsp;<br></div><div>&nbsp;<br></div><div><span style="font-size: 19px;"><span style="font-weight: bold;">Centos 6 (FS en ext)</span></span></div><div>&nbsp;<br></div><div>Avec tune2fs (<span style="color: rgb(255, 0, 0);">ne fonctionne que pour les FS en extX</span>), on peut voir les 3 conditions pour un fsck automatique au boot :</div><div>&nbsp;<br></div><div>- Si le FS n'est pas marqué "clean".</div><div>- Si le FS "Mount Count" supérieur à "Maximum Mount Count". Ici il est à -1 donc il peut-être monté à l'infini sans être checké.</div><div>- S'il y a plus de "Check interval" jours avec le "Last checked" donc si supérieur au "Next check after"'</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos1 ~]# tune2fs -l /dev/sda1</div><div>tune2fs 1.41.12 (17-May-2010)</div><div>Filesystem volume name:&nbsp; &nbsp;&lt;none&gt;</div><div>Last mounted on:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /boot</div><div>Filesystem UUID:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3d8158db-a454-48e0-bc00-9f2a492656f1</div><div>Filesystem magic number:&nbsp; 0xEF53</div><div>Filesystem revision #:&nbsp; &nbsp; 1 (dynamic)</div><div>Filesystem features:&nbsp; &nbsp; &nbsp; has_journal ext_attr resize_inode dir_index filetype needs_recovery extent flex_bg sparse_super huge_file uninit_bg dir_nlink extra_isize</div><div>Filesystem flags:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;signed_directory_hash</div><div>Default mount options:&nbsp; &nbsp; user_xattr acl</div><div><span style="background-color: rgb(255, 250, 165);">Filesystem state:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;clean</span></div><div>Errors behavior:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Continue</div><div>Filesystem OS type:&nbsp; &nbsp; &nbsp; &nbsp;Linux</div><div>Inode count:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 128016</div><div>Block count:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 512000</div><div>Reserved block count:&nbsp; &nbsp; &nbsp;25600</div><div>Free blocks:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 461198</div><div>Free inodes:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127978</div><div>First block:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</div><div>Block size:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1024</div><div>Fragment size:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1024</div><div>Reserved GDT blocks:&nbsp; &nbsp; &nbsp; 256</div><div>Blocks per group:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</div><div>Fragments per group:&nbsp; &nbsp; &nbsp; 8192</div><div>Inodes per group:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2032</div><div>Inode blocks per group:&nbsp; &nbsp;254</div><div>Flex block group size:&nbsp; &nbsp; 16</div><div>Filesystem created:&nbsp; &nbsp; &nbsp; &nbsp;Wed May&nbsp; 3 11:44:24 2017</div><div>Last mount time:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mon May 22 14:46:17 2017</div><div>Last write time:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mon May 22 14:46:17 2017</div><div><span style="background-color: rgb(255, 250, 165);">Mount count:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5</span></div><div><span style="background-color: rgb(255, 250, 165);">Maximum mount count:&nbsp; &nbsp; &nbsp; -1</span></div><div><span style="background-color: rgb(255, 250, 165);">Last checked:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Wed May&nbsp; 3 11:44:24 2017</span></div><div><span style="background-color: rgb(255, 250, 165);">Check interval:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 (&lt;none&gt;)</span></div><div>Lifetime writes:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64 MB</div><div>Reserved blocks uid:&nbsp; &nbsp; &nbsp; 0 (user root)</div><div>Reserved blocks gid:&nbsp; &nbsp; &nbsp; 0 (group root)</div><div>First inode:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11</div><div>Inode size:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;128</div><div>Journal inode:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</div><div>Default directory hash:&nbsp; &nbsp;half_md4</div><div>Directory Hash Seed:&nbsp; &nbsp; &nbsp; 50b69d25-b096-4eb5-9969-1eac43a9d91e</div><div>Journal backup:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inode blocks</div><div>&nbsp;<br></div></div><div>&nbsp;<br></div><div><span style="font-size: 21px;">Comment lancer un fsck sur tout le system au boot ?</span></div><div>&nbsp;</div><div><a href="https://access.redhat.com/articles/1461">https://access.redhat.com/articles/1461</a></div><div>&nbsp;<br></div><div>If you only want to run fsck on the next boot, please execute the following as the root user:</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div># cd /</div><div># touch forcefsck</div></div><div>&nbsp;<br></div><div>This will only run the file system check on the next reboot. By touching the file "forcefsck" in the / directory, it will force the system to perform a full file system check.</div><div>&nbsp;<br></div><div>The file "forcefsck" will be deleted automatically after fsck is finished.</div><div>&nbsp;<br></div><div>Note: For systems with large disks, fsck on boot may take a long time to run depending on system speed and disk sizes.</div><div>&nbsp;<br></div><div>J'ai déjà eu à le faire un jour. Voici la note correspondante :</div><div>&nbsp;<br></div><div><a href="https://www.evernote.com/shard/s72/nl/8374248/b3fd06be-7934-4fdc-b4b2-1377ee1f53f6" style="color: rgb(105, 170, 53);">"Unexpected inconsistency : run fsck manually"</a></div><div>&nbsp;<br></div><div><span style="font-size: 21px;">Pour lancer un fsck manuellement sur un FS non-monté (qui n'est donc pas le fs root) :</span></div><div>&nbsp;<br></div><div>D'abord pour vérifier si le FS est considéré comme clean (donc il ne va pas vérifier et corriger les blocks) :</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos1 ~]# fsck /boot</div><div>fsck from util-linux-ng 2.17.2</div><div>e2fsck 1.41.12 (17-May-2010)</div><div>/dev/sda1 is mounted.</div><div><span style="color: rgb(255, 0, 0);">e2fsck: Cannot continue, aborting.</span></div><div>&nbsp;<br></div><div>[root@centos1 ~]# umount /boot/</div><div>&nbsp;<br></div><div>[root@centos1 ~]# fsck /boot</div><div>fsck from util-linux-ng 2.17.2</div><div>e2fsck 1.41.12 (17-May-2010)</div><div><span style="color: rgb(50, 135, 18);">/dev/sda1: clean, 44/128016 files, 79694/512000 blocks</span></div><div>&nbsp;<br></div></div><div>&nbsp;<br></div><div><span style="color: rgb(255, 0, 0);">Attention ci-dessus, le FSCK n'a rien checké au niveau des blocs !</span> Il a juste regardé si le FS était considéré (noté par un flag que l'on peut vérifier avec tune2fs) comme "à réparer / clean / not clean".&nbsp;</div><div>&nbsp;<br></div><div>Pour le forcer à vérifier complètement :</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">[root@centos1 ~]# fsck <span style="background-color: rgb(255, 250, 165);">-f</span> /boot</div><div>&nbsp;<br></div><div>Le problème c'est que s'il rencontre des erreurs, il va demander à chaque fois si on souhaite réparer oui ou non. S'il y a bcp d'erreur ça risque d'être ennuyant et il faudra rester devant l'écran. Il faut donc pour que "yes" soit répondu interactivement à chaque fois rajouter l'option "-y" :</div><div>&nbsp;<br></div><div>On rajoute l'option "V" (ou -v apparemment ça n'aurait pas d'importance) pour avoir un peu de verbositée.</div><div>&nbsp;<br></div><div><span style="font-weight: bold;">Note</span> : Apparemment il y a aussi l'option -C qui permet d'avoir une barre de progression du fsck pour (d'après le man) les FS en&nbsp;<span style="font-weight: bold;">EXT-2 et 3 (en fait, vérifier d'abord dans le man, j'ai rencontré le cas où on avait seulement ext-2 supporté)</span>. Je l'ai testé sur un EXT-4 et j'ai eu un barre de progression.</div><div>&nbsp;<br></div><div><span style="background-color: rgb(255, 250, 165); color: rgb(255, 0, 0);">Donc la commande complète est :</span></div><div>&nbsp;<br></div><div style="padding: 8px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;"><b><font color="#ff0000"># fsck -fyVC /boot</font></b></span></span></div><div>&nbsp;<br></div><div>Au lancement, j'ai bien une barre de progression. L'étape "Pass 1" est la plus longue suivant le nombre de fichiers, le nombre à corriger, la taille du FS etc. (impossible à évaluer) :</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@~]# fsck -fyVC /data/cfa000/p1/data</div><div>fsck from util-linux-ng 2.17.2</div><div>[/sbin/fsck.ext4 (1) -- /data/cfa000/p1/data] fsck.ext4 -fy -C0 /dev/mapper/data_vg-data_lv</div><div>e2fsck 1.41.12 (17-May-2010)</div><div>Pass 1: Checking inodes, blocks, and sizes</div><div><font color="#FF0000">/dev/mapper/data_vg-data_lv: |==&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\&nbsp;&nbsp;6.0%</font></div></div><div>&nbsp;<br></div><div>Les étapes 2, 3 et 4 sont rapides. L'étape 5 peut encore prendre quelques minutes :</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@~]# fsck -fyVC /data/cfa000/p1/data</div><div>fsck from util-linux-ng 2.17.2</div><div>[/sbin/fsck.ext4 (1) -- /data/cfa000/p1/data] fsck.ext4 -fy -C0 /dev/mapper/data</div><div>e2fsck 1.41.12 (17-May-2010)</div><div>Pass 1: Checking inodes, blocks, and sizes</div><div>Pass 2: Checking directory structure</div><div>Pass 3: Checking directory connectivity</div><div>Pass 4: Checking reference counts</div><div>Pass 5: Checking group summary information</div><div>/dev/mapper/data_vg-data_lv: 96280669/106168320 files (0.0% non-contiguous), 137135627/424669184 blocks</div></div><div>&nbsp;<br></div><div><span style="font-weight: bold;">Pour faire un fsck des FS qui sont marqués comme à vérifier au boot dans la fstab :</span></div><div>&nbsp;</div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"># fsck -A</div><div>&nbsp;</div><div>&nbsp;<br></div><div><span style="font-size: 15px;"><span style="font-weight: bold;">FSCK sur FS ROOT</span></span></div><div>&nbsp;<br></div><div>Si le fsck doit être fait sur le FS root (et qu'on ne souhaite pas utiliser la méthode du forcefsck plus haut, par exemple un système qui ne boot pas), on ne peut le faire qu'en <span style="color: rgb(255, 70, 53); font-weight: bold;">bootant sur un ISO et chargeant le rescue</span>. Suivre la KB Redhat suivante :</div><div>&nbsp;<br></div><div><a href="https://access.redhat.com/solutions/9541">https://access.redhat.com/solutions/9541</a>&nbsp; -----&gt;&nbsp; <a href="https://www.evernote.com/shard/s72/nl/8374248/b05c1e50-dde1-4d68-8942-3401c7643555" style="color: rgb(105, 170, 53);">How to repair filesystem in rescue mode for Red Hat Enterprise Linux</a></div><div>&nbsp;<br></div><div>Pour booter en rescue :</div><div>&nbsp;<br></div><div><a href="https://www.evernote.com/shard/s72/nl/8374248/81591e43-89a7-44ac-a670-d2ffb6d9d90f" style="color: rgb(105, 170, 53);">Boot rescue et chrooter le system</a></div><div>&nbsp;<br></div><div>Note : Une fois, je ne pouvais vraiment pas faire autrement que de le faire à chaud. Je l'ai lancé sur "/" et c'est passé sans pbm très vite + reboot après.</div><div>&nbsp;<br></div><hr><div>&nbsp;<br></div><div><span style="font-size: 14pt;">L'opération de FSCK a-t-elle corrigé quelque chose ?</span></div><div><font style="font-size: 14pt;">&nbsp;<br></font></div><div><span style="font-size: 10pt;">After doing a fsck on a filesystem, someone asked me if the fsck resolved any problems. I'm not sure how to interprete the following results. Do you see anything important to notice ?</span></div><div><font style="font-size: 14pt;">&nbsp;<br></font></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>root@server1&gt; fsck -fyv /donnees</div><div>fsck 1.35 (28-Feb-2004)</div><div>e2fsck 1.35 (28-Feb-2004)</div><div>Pass 1: Checking inodes, blocks, and sizes</div><div>Pass 2: Checking directory structure</div><div>Pass 3: Checking directory connectivity</div><div>Pass 4: Checking reference counts</div><div>Pass 5: Checking group summary information</div><div>&nbsp;<br></div><div>1468099 inodes used (0%)</div><div>114532 non-contiguous inodes (7.8%)</div><div># of inodes with ind/dind/tind blocks: 456970/35761/8</div><div>249447788 blocks used (77%)</div><div>0 bad blocks</div><div>19 large files</div><div>&nbsp;<br></div><div>1176399 regular files</div><div>291142 directories</div><div>0 character device files</div><div>0 block device files</div><div>140 fifos</div><div>2 links</div><div>407 symbolic links (403 fast symbolic links)</div><div>2 sockets</div><div>--------</div><div>1468092 files</div><div><span style="font-size: 9pt;">&nbsp;<br></span></div></div></div><div>&nbsp;<br></div><div>The best way to determine whether this particular fsck operation corrected any errors would have been to check its exit code: e2fsck sets bit 1 of its exit code if it corrected errors, and bit 2 if it corrected errors requiring a reboot (i.e. on a mounted file system).</div><div>&nbsp;<br></div><div>You can also determine that e2fsck didn’t make any change here, because the output doesn’t mention ***** FILE SYSTEM WAS MODIFIED *****</div><div>which e2fsck outputs if it made any changes (unless the -p option was specified).</div><div>&nbsp;<br></div>