Le device (ici un smartphone) tente de se connecter à internet en passant par un premier proxy SQUID (qui va filtrer sur certains domains url) et sort sur internet par un proxy Blue Coat (qui fait également du filtrage web).&nbsp;<div>Le Blue Coat écoute les requêtes sur le port 9090.&nbsp;<div>Il y a dans les logs du proxy squid des erreur de TCP_DENIED sur des URL avec port 80.&nbsp;</div><div>Pour shunter le proxy SQUID afin de vérifier que ce n'est pas lui qui bloque, je test la connexion à la page web de destination avec curl directement depuis le Linux squid.</div><div>Il faut préciser dans les paramètres de curl que l'on passe par le proxy Blue Coat ou pas :</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><blockquote><font face="menlo">curl -v --proxy http://ip_du_proxy:9090 ip_ou_url_du_site_web_a_atteindre</font></blockquote><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><a href="https://stackoverflow.com/questions/9445489/performing-http-requests-with-curl-using-proxy">https://stackoverflow.com/questions/9445489/performing-http-requests-with-curl-using-proxy</a></div><div><a href="https://catonmat.net/cookbooks/curl/debug-curl-requests">https://catonmat.net/cookbooks/curl/debug-curl-requests</a>&nbsp;&nbsp;&nbsp;<br></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div>Dans le résultat (en précisant que l'on veut passer par un proxy), on a plusieurs infos :</div></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div>- Si la connexion a pu se faire</div><div>- Le code retour délivré par la page web (ici 400)</div><div>- Parfois des infos sur le host donc le serveur web qui répond (ici Akamai qui semble être un proxy cache)</div><div>- Le code HTML de la page web qui est répondue</div><div>- et la dernière ligne indique si on passe bien par le proxy précisé ou pas. Sinon (voir plus loin, on passe par le local 127.0.0.1 donc par le squid lui-même qui lui va interroger le Blue Coat). Mais je n'ai pas toujours eu cette info.</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><u>A savoir :</u></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div>Lines prefixed by &gt; is the data sent to the server</div><div>Lines prefixed by &lt; is the data received from the server</div><div>Lines starting with * is misc information, such as connection information, SSL handshake information, and protocol information.</div><div>&nbsp;&nbsp;&nbsp;<br></div><blockquote><div><font face="menlo">* About to connect() to proxy 172.XX.XX.XX port 9090 (#0)&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>*&nbsp;&nbsp; Trying 172.XX.XX.XX... connected&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>* <font color="#ff0000">Connected </font>to 172.XX.XX.XX (172.XX.XX.XX) port 9090 (#0)&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&gt; GET http://ip_site_web_a_joindre/ HTTP/1.1&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&gt; Host: ip_site_web_a_joindre&nbsp;&nbsp;&nbsp;<br>&gt; Accept: */*&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&gt; Proxy-Connection: Keep-Alive&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>* HTTP 1.0, assume close after body&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;<font color="#ff0000"> HTTP/1.0 400 Bad Request&nbsp;</font>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt; <font color="#ff0000">Server: AkamaiGHost</font>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>...&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;HTML&gt;&lt;HEAD&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;TITLE&gt;Invalid URL&lt;/TITLE&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;/HEAD&gt;&lt;BODY&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;H1&gt;Invalid URL&lt;/H1&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>The requested URL "&amp;#91;no&amp;#32;URL&amp;#93;", is invalid.&lt;p&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>Reference&amp;#32;&amp;#35;9&amp;#46;5e701602&amp;#46;1606728592&amp;#46;39345047&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;/BODY&gt;&lt;/HTML&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>* <font color="#ff0000">Connection #0 to host <span style="background-color: rgb(255, 255, 0);">172.XX.XX.XX</span> left intact&nbsp;</font>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>* Closing connection #0&nbsp;&nbsp;&nbsp; </font>&nbsp;&nbsp;&nbsp;<br></div></blockquote><div>&nbsp;&nbsp;&nbsp;<br><div>et si je ne précise pas de passer par le proxy Blue Coat, on passe en local (donc par nous-même le proxy squid) :</div><div>&nbsp;</div><blockquote><div><font face="menlo">* About to connect() to proxy 127.0.0.1 port 8000 (#0)&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>*&nbsp;&nbsp; Trying 127.0.0.1... connected&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>* Connected to 127.0.0.1 (127.0.0.1) port 8000 (#0)&nbsp;&nbsp;&nbsp;<br>&gt; GET http://ip_site_web_a_joindre/ HTTP/1.1&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&gt; Host: ip_site_web_a_joindre&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&gt; Accept: */*&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&gt; Proxy-Connection: Keep-Alive&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>* HTTP 1.0, assume close after body&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt; HTTP/1.0 400 Bad Request&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt; Server: AkamaiGHost&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>...&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;HTML&gt;&lt;HEAD&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;TITLE&gt;Invalid URL&lt;/TITLE&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;/HEAD&gt;&lt;BODY&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;H1&gt;Invalid URL&lt;/H1&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>The requested URL "&amp;#91;no&amp;#32;URL&amp;#93;", is invalid.&lt;p&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>Reference&amp;#32;&amp;#35;9&amp;#46;135b4350&amp;#46;1606729574&amp;#46;c1a8583&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>&lt;/BODY&gt;&lt;/HTML&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>* <font color="#ff0000">Connection #0 to host <span style="background-color: rgb(255, 255, 0);">127.0.0.1</span> left intact</font>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br>* Closing connection #0</font>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br></div></blockquote>&nbsp;&nbsp;&nbsp;<br>Pour afficher le code retour HTTP et le code retour curl (qui peut donner des informations en plus) :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div><blockquote><font face="menlo"># curl --proxy 172.XX.XX.XX:9090 -w 'Response code: %{response_code}\n' -s -o /dev/null&nbsp; https://site_web/index.html&nbsp; ; echo "Exit code curl: $?"&nbsp;&nbsp;&nbsp;<br>Response code: 200&nbsp;&nbsp;&nbsp;<br>Exit code curl: 0</font>&nbsp;&nbsp;&nbsp;<br></blockquote>&nbsp;&nbsp;&nbsp;<br></div><div>Code retours CURL : <a href="https://curl.se/libcurl/c/libcurl-errors.html">https://curl.se/libcurl/c/libcurl-errors.html</a></div>