<div>Redémarer les agents n'aura pas d'impacts sur les VMs en production ou sur l'ESXi :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>No Impact on the ESX or Vms, The VMs will continue to run, but will <span style="background-color: rgb(255, 250, 165);">show as disconnected</span>.</div><div>It will be stopping and starting the management service and during this time you will see the vms are disconnected from the vcenter.</div><div>Also your vm console via vcenter will get disconnected. Once agent gets restarted the host and vm gets connected to VC back within a minute or so.</div></div><div>&nbsp;&nbsp;&nbsp;<br></div><div>Attention quand même au point suivant :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">Restarting of management agents will stop/terminate the current running process in the host (Cloning, Image backup (VCB), vMotion, SVMotion) the vms will not be impacted but there is something called APD (All path dead) introduced in 4.0 i guess, if your ESXi host LUN/LUNs are in APD state there are more possibility that the hostd agent will not restart successfully. You will have to end up in restarting the host to remove APD condition.</span></span></div><div>&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">So before restarting the managament agents make sure you do not have LUNs in APD condition. You can have a look at the below article</span></span></div><div>&nbsp;&nbsp;&nbsp;<br></div><div><a href="https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1030980">https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1030980</a></div></div><div>&nbsp;&nbsp;&nbsp;<br></div><div>Mais en général, on peut redémarrer les services de management d'un ESXi sans trop de craintes.&nbsp;</div><div><hr></div><div>Les deux agents de management qui seront redémarrés sont :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div>hostd : Daemon/service ESXi</div><div>vpxa : Agent vCenter sur l'ESXi</div><div>&nbsp;&nbsp;&nbsp;<br></div><div><font color="#69aa35"><a href="https://www.cnot.tpoz.fr/index.php?doss=VMware%20-%20ALL&amp;note=Agent+et+Daemon+VMware">Agent et Daemon VMware</a></font></div><div>&nbsp;&nbsp;&nbsp;<br></div><div><hr></div><div>&nbsp;&nbsp;&nbsp;<br></div><div>En ssh, on peut redémarrer soit module par module par exemple le hostd et le vpxa (les principaux) :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div># /etc/init.d/hostd restart</div><div># /etc/init.d/vpxa restart</div></div><div>&nbsp;&nbsp;&nbsp;<br></div><div>soit tous les services de l'ESXi avec :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"># service.sh restart</div><div>&nbsp;&nbsp;&nbsp;<br></div><div><span style="color: rgb(255, 0, 0);">MAIS ATTENTION avec cette méthode :&nbsp;</span></div><div>&nbsp;&nbsp;&nbsp;<br></div><div align="left" style="min-height: 13pt;"><span style="font-size: 11pt; color: rgb(1, 1, 1); font-family: Calibri;">Si on utilise la commande "services.sh restart" pour redémarrer les services d'un ESXi, les VM perdent le réseau le temps du restart si la conf est la suivante :</span></div><div align="left" style="min-height: 13pt;"><span style="font-size: 11pt; color: rgb(1, 1, 1); font-family: Calibri;">- vSphere 5.5.x et&nbsp;</span><span style="font-size: 11pt; color: rgb(1, 1, 1); font-family: Calibri;">6.0.x</span></div><div align="left" style="min-height: 13pt;"><span style="font-size: 11pt; color: rgb(1, 1, 1); font-family: Calibri;">- Distributed Switch pour le réseau des VMs</span></div><div align="left" style="min-height: 13pt;"><span style="font-size: 11pt; color: rgb(1, 1, 1); font-family: Calibri;">- LACP (LAG) activé sur le DVS</span></div><div align="left" style="min-height: 13pt;">&nbsp;&nbsp;&nbsp;<br></div><div align="left" style="min-height: 13pt;"><span style="font-size: 11pt; color: rgb(1, 1, 1); font-family: Calibri;">Si besoin de redémarrer les services, il faut les faire module par modules.</span></div><div align="left" style="min-height: 13pt;"><span style="font-size: 11pt; color: rgb(1, 1, 1); font-family: Calibri;">https://kb.vmware.com/s/article/2117958</span></div><div>&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-weight: bold;">OU BIEN</span></div><div>&nbsp;&nbsp;&nbsp;<br></div><div>En ssh + dcui :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div># dcui</div><div>&nbsp;&nbsp;&nbsp;<br></div><div>- Press&nbsp;F2&nbsp;to customize the system.</div><div>- Log in as&nbsp;root.</div><div>- Use the Up/Down arrows to navigate to&nbsp;Troubleshooting Options&nbsp;&gt;&nbsp;Restart Management Agents.</div><div>- Press&nbsp;Enter.</div><div>- Press&nbsp;F11&nbsp;to restart the services.</div><div>- When the service restarts, press&nbsp;Enter.</div><div>- Press&nbsp;Esc&nbsp;to log out.</div></div><div>&nbsp;&nbsp;&nbsp;<br></div><div>En ilo ou console locale sur l'ESXi :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>- Connect to the console of your ESXi host.</div><div>- Press&nbsp;F2&nbsp;to customize the system.</div><div>- Log in as&nbsp;root.</div><div>- Use the Up/Down arrows to navigate to&nbsp;Troubleshooting Options&nbsp;&gt;&nbsp;Restart Management Agents.</div><div>- Press&nbsp;Enter.</div><div>- Press&nbsp;F11&nbsp;to restart the services.</div><div>- When the service restarts, press&nbsp;Enter.</div><div>- Press&nbsp;Esc&nbsp;to log out.</div></div><div>&nbsp;&nbsp;&nbsp;<br></div><div>ou en ilo ou console locale sur l'ESXi :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div>Note : L'ESXi shell peut aussi être activé depuis vsphere client dans configuration &gt; security profile &gt; Services &gt; Properties &gt; ESXi Shell &gt; Options.... &gt; Start</div><div>&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>- Activer l'ESXi Shell dans "Troubleshooting Mode Options"</div><div>- Revenir à l'écran principal</div><div>- ALT+F1 pour avoir un shell&nbsp;</div><div>- ALT+F2 pour quitter le shell et revenir au graphique</div></div><div>&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 15px;"><span style="font-weight: bold;">Redémarrer avec Powercli :</span></span></div><div>&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">Get-VMHostService -VMHost MyEsx |</span></div><div><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">where {$_.Key -eq "vpxa"} |</span></div><div><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">Restart-VMHostService -Confirm:$false -ErrorAction SilentlyContinue</span></div></div><div>&nbsp;&nbsp;&nbsp;<br></div><div>Tous ceux du cluster :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>Get-vmhost | Get-VmHostService |&nbsp;where {$_.Key -eq "vpxa"} |</div><div>Restart-VMHostService -Confirm:$false -ErrorAction SilentlyContinue</div></div><div>&nbsp;&nbsp;&nbsp;<br></div><div>Sans confirmation :</div><div>&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>Get-vmhost | Get-VmHostService |&nbsp;where {$_.Key -eq "vpxa"} |</div><div>Restart-VMHostService -Confirm:$false -ErrorAction SilentlyContinue</div></div><div>&nbsp;&nbsp;&nbsp;<br></div>