<div>"Virtual machine disks consolidation is needed"</div><div>&nbsp;&nbsp;<br></div><div><hr></div><div>&nbsp;&nbsp;<br></div><div>Déplacer des VM du datastore pour laisser de l'espace pour la consolidation de la VM concernée.</div><div>&nbsp;&nbsp;<br></div><div><hr></div><div><span style="font-size: 14pt;">&nbsp;&nbsp;<br></span></div><div><span style="font-size: 19px;"><span style="font-weight: bold;">Cas 1 :</span></span></div><div>&nbsp;&nbsp;<br></div><div>En faisant consolidate :</div><div><span style="color: rgb(255, 0, 0);">" Unable to access file &lt;unspecified filename&gt; since it is locked"</span></div><div>En browsant le datastore sur lequel se trouve la VM, on voit qu'il y a deux répertoires :</div><div>vmname et vmname_1</div><div>Dans le répertoire vmname, il n'y a que le fichier .nvram de la VM (Bios) et dans l'autre tous les fichiers de la VM.</div><div>Test storage vmotion mais KO -&gt; "<span style="color: rgb(255, 0, 0);">Error caused by file /vmfs/..../vmname.vmdk</span>"</div><div>&nbsp;&nbsp;<br></div><div>Il faut le faire à froid.</div><div>&nbsp;&nbsp;<br></div><div>Tester de redémarrer les services de l'ESXi ???&nbsp;&nbsp; <font color="#69aa35"><a href="https://www.cnot.tpoz.fr/index.php?doss=VMware%20-%20ALL&amp;note=Restart+management+agent+ESXi">Restart management agent ESXi</a></font></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 19px;"><span style="font-weight: bold;">Cas 2 :&nbsp;</span></span></div><div>&nbsp;</div><div>En faisant consolidate :</div><div><span style="color: rgb(255, 0, 0);">"Unable to access file &lt;unspecified filename&gt; since it is locked"</span></div><div>En browsant le datastore, il n'y a qu'un seul répertoire (donc on est pas dans le cas 1).</div><div>Si je veux faire une storage vmotion de la VM, lorsque je choisi un datastore de destination :</div><div>"<span style="color: rgb(255, 0, 0);">The virtual machine is installing VMware Tools and cannot initiate a migration operation</span>"</div><div>Raison : le cd des tools est monté.</div><div>&nbsp;&nbsp;<br></div><div><a href="https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1038542">https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1038542</a></div><div>&nbsp;&nbsp;<br></div><div>Déconnecter le cd n'a pas résolu mon pbm. J'ai toujours le message d'erreur des tools.</div><div>D'après le KB, ça peut ne pas résoudre le pbm pour les linux et dans ce cas il faut éteindre la VM.</div><div>Mais avant ça, il y a d'autres choses possibles à faire --&gt; suivre la KB jusqu'à la fin même dans "related informations".</div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 19px;"><span style="font-weight: bold;">Cas 3 :</span></span></div><div>&nbsp;&nbsp;<br></div><div>Consolidate KO</div><div>Storage vmotion KO "Error caused by file /vmfs/.../VMNAME_3.vmdk</div><div>Se connecter à l'ESX en ssh :</div><div>cd vmfs/volumes/nomdudatastore/vmname &nbsp;--&gt; on voit qu'il y a plein de fichiers .ctk qui sont des fichiers CBT (change block tracking). <span style="font-weight: bold;">Normalement, on devrait avoir un fichier .ctk par disque vmdk</span>.</div><div>Dans mon cas, j'en ai plusieurs pour certains disques. VMware n'arrive plus à les consolider.</div><div><span style="text-decoration-line: line-through;">Demande d'éteindre la VM et essayer de consolider.</span></div><div>&nbsp;&nbsp;<br></div><div align="left" style="min-height: 11pt;"><div><span style="font-size: 10pt; color: rgb(255, 0, 0); font-family: Arial;"><span style="font-size: 10pt; font-weight: bold;">C'est un problème de lock</span> -&gt; dans les logs : "Unable to access file &lt;unspecified filename&gt; since it is locked".</span></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt; color: rgb(1, 1, 1); font-family: Arial;">Pour trouver le ou les fichiers qui sont lockés, se connecter en ssh sur l'esx et se mettre dans le dossier de la vm :</span></div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div># cat vmware.log | grep -i lock</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ...</div><div>2017-07-13T21:08:30.328Z| vcpu-0| I120: AIOGNRC: Failed to open '/vmfs/volumes/<span style="background-color: rgb(255, 250, 165);">52301ea8-354d2ca4-365e-0017a477fc10/VMXXX/VMXXX_3-flat.vmdk</span>' : Failed to lock the file (40003) (0x2013).</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ...</div></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt; color: rgb(1, 1, 1); font-family: Arial;">Pour trouver l'ESX qui lock les fichiers :</span></div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div># vmkfstools -D /vmfs/volumes/<span style="background-color: rgb(255, 250, 165);">52301ea8-354d2ca4-365e-0017a477fc10/VMXXX/VMXXX_3-flat.vmdk</span> | grep "RO Owner"</div><div>RO Owner[0] HB Offset 3846144 5476dcda-ed0070b4-d6d1-<span style="background-color: rgb(255, 250, 165);">0017a477fc20</span></div><div>RO Owner[1] HB Offset 3833856 5476e5c7-33827600-8141-<span style="background-color: rgb(255, 250, 165);">0017a477f880</span></div></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt; color: rgb(1, 1, 1); font-family: Arial;">Pour trouver l'ESX qui lock grâce à son adresse MAC :</span></div><div>&nbsp;&nbsp;<br></div><div><span style="background-color: rgb(255, 250, 165); font-size: 10pt; color: rgb(1, 1, 1); font-family: Arial;">0017a477f880</span> <span style="font-size: 10pt; color: rgb(1, 1, 1); font-family: Arial;">correspond à l'adresse MAC de la patte vmnic0 de l'ESX qui héberge la VM (vérifier ça dans le vcenter &gt; Configuration &gt; Network Adapters) donc ce n'est pas cet ESX qui est en cause mais plutôt celui avec l'adresse MAC</span> <span style="background-color: rgb(255, 250, 165); font-size: 10pt; color: rgb(1, 1, 1); font-family: Arial;">0017a477fc20</span><span style="font-size: 10pt; color: rgb(1, 1, 1); font-family: Arial;">, c'est à dire un autre ESXi.</span></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt; color: rgb(1, 1, 1); font-family: Arial;">Délocker les fichiers sur l'ESX en cause en redémarrant les services de l'ESX :&nbsp;</span><span style="background-color: rgb(255, 255, 255); outline-color: initial; outline-style: initial;"><u><a href="https://www.cnot.tpoz.fr/index.php?doss=VMware%20-%20ALL&amp;note=Restart+management+agent+ESXi">Restart management agent ESXi</a></u></span></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt; color: rgb(1, 1, 1); font-family: Arial;">Relancer le consolidate.&nbsp;</span><span style="font-size: 10pt; color: rgb(1, 1, 1); font-family: Arial;">La consolidation est en cours, ça peut être très long comme ça peut être rapide.</span></div></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 19px;"><span style="font-weight: bold;">Cas 4 :</span></span></div><div>&nbsp;&nbsp;<br></div><div>Consolidate KO ---&gt; <span style="color: rgb(255, 0, 0);">A générale system error occured: The parent virtual disk has been modified since the child was created. The content ID of the parent virtual disk does not match the corresponding parent content ID in the child.</span></div><div>&nbsp;&nbsp;<br></div><div>Storage vMotion KO --&gt;<span style="color: rgb(255, 0, 0);">&nbsp;"Error caused by file /vmfs/.../VMNAME_1-000002.vmdk"</span></div><div>&nbsp;&nbsp;<br></div><div>Pas de messages d'erreurs concernant des locks éventuels (voir cas 3 ci-dessus).</div><div>&nbsp;&nbsp;<br></div><div>En fait, la chaine des snapshot du deuxième disque était cassée (CID mismatch). Suivre la procédure suivante pour reconfigurer les fichiers .vmdk + désinventorier-réinventorier la VM + power on + snasphot consolidation.</div><div>&nbsp;&nbsp;<br></div><div>"The parent virtual disk has been modified since the child was created" error (1007969)</div><div><a href="https://kb.vmware.com/s/article/1007969">https://kb.vmware.com/s/article/1007969</a></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 19px;"><span style="font-weight: bold;">Cas 5 :</span></span></div><div>&nbsp;&nbsp;<br></div><div>En faisant consolidate :</div><div><span style="color: rgb(255, 0, 0);">" Unable to access file &lt;unspecified filename&gt; since it is locked"</span></div><div>Pas cas 1 ni 2.</div><div>S'il n'y avait que quelques VM dessus, les migrer et rebooter l'ESX.</div><div>Storage vmotion --&gt; "<span style="color: rgb(255, 0, 0);">The method is disabled by Netbackup Lock by JobId XXX</span>"</div><div>Je n'ai pas accès à l'ESX pour redémarrer les service du host ce qui résoud généralement les soucis de locks ---&gt; voir <span style="font-weight: bold;">CAS 3</span></div><div>vmotion --&gt; ok&nbsp;</div><div>re storage vmotion --&gt; ko toujours pareil</div><div>re consolidate --&gt; ko toujours pareil</div><div>Mise en maintenance de l'ESX sur lequel se trouvait la VM avant que je la vmotion.</div><div>Reboot de cet ESXi ---&gt; Mickaël me dit que sa sauvegarde s'est plantée. En fait le pbm venait de là, une sauvegarde était toujours en cours (donc le snap pas encore supprimé). Ce qui a mis le message "consolidate needed" et que qqn a relancé par ctrlm la sauvegarde donc deux sauvegardes en même temps.</div><div>Une fois le job netbackup killé (par mon reboot de l'ESXi), le consolidate se fait bien puis relance de la save.</div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 19px;"><span style="font-weight: bold;">Cas 6 :</span></span></div><div>&nbsp;&nbsp;<br></div><div>Plus de places sur le datastore pour faire le consolidate.</div><div>Un popup l'indique et demande si on retry ou si on cancel.</div><div>La VM est inaccessible.</div><div>Sur le datastore, il y 4 disques de la VMs.</div><div>Je tente d'en déplacer un, il tombe en erreur me disant qu'il faut d'abord que je réponde à la question car plus de place sur le datastore... On se mord la queue.</div><div>Suppression de vieux fichiers de logs... Ne résoud pas le soucis. Toujours pas assez de place.</div><div>Demande à l'équipe stockage d'ajouter une LUN de 2To aux ESXi.&nbsp;</div><div>Rescan de chaque ESXi du cluster.</div><div>Increase du datastore avec la nouvelle LUN (Cliquer sur le datastore &gt; configuration &gt; Propriétés &gt; Increase &gt; sélectionner la nouvelle LUN pour agrandir le datastore à CHAUD.</div><div>Répondre à la question RETRY + lancer le consolidate.</div><div>&nbsp;&nbsp;<br></div><div>NOTE : Quand on tente de faire une opération sur une VM alors que le datastore est full, la première chose que fait VMware est de tenter d'écrire dans les logs et comme il n'y a plus de place il plante. Il faudra parfois éteindre le serveur, supprimer des logs pour faire un peu de place.</div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 19px; font-weight: bold;">Cas 7 :</span></div><div><span style="font-size: 19px;">&nbsp;&nbsp;<br></span></div><div>vmotion ok</div><div>Je n'ai pas fait de storage vmotion car la vm est éclatée sur 6 datastores.</div><div>consolidate KO après vmotion</div><div>Dans le vmware.log, pas d'erreur de lock.</div><div>Similaire au cas 5, après vérification auprès de l'équipe de sauvegarde, il y a bien une sauve en cours. Je leur ai demandé de la killer.&nbsp;</div><div>&nbsp;&nbsp;<br></div><div>CAS 8 :</div><div>&nbsp;&nbsp;<br></div><div>La VM ne démarre pas ou le consolidate indique :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><font color="#FF0000">"Detected an invalid snapshot configuration"</font></div><div>&nbsp;&nbsp;<br></div><div>Vérifier si les disques sont à 0 -&gt;&nbsp; <font color="#000000"><a href="https://www.cnot.tpoz.fr/index.php?doss=VMware%20-%20ALL&amp;note=Impossible+de+d%C3%A9marrer+une+VM+%2F+Disque+VMDK+%C3%A0+0+-+vm+orpheline">Impossible de démarrer une VM / Disque VMDK à 0 - vm orpheline</a></font></div>