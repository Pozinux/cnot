<div>Un fichier flat.vmdk traine sur un datastore.&nbsp;</div><div>Je tente de le supprimer en client -&gt; failed car busy</div><div>En fait, le fichier est locké/utilisé par un process d'un ESX.</div><div>Il faut trouver quel ESX du cluster lock le fichier.</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><a href="https://kb.vmware.com/s/article/1008728">https://kb.vmware.com/s/article/1008728</a></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div>En ssh sur l'ESXi :</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">vmkfstools -D&nbsp;path_vers_le_fichier</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div>Il donne une ligne :</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">&nbsp;.... owner 479f5a1a-0855d3ff-7288-<span style="background-color: rgb(255, 250, 165);">0017a446ae31</span>&nbsp;...</div><div>&nbsp;</div><div>la partie en jaune représente la MAC ADDR de la carte réseau de management de l'ESXi qui lock :&nbsp;&nbsp;<span style="font-size: 13.3333px; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;">00:17:A4:46:AE:31</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div>On peut comparer avec les MAC que l'on voit dans vCenter dans Configuration &gt; Network Adapter de chaque ESXi du cluster.</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div>OU BIEN plus rapide avec les RVTOOLS en cherchant dans tout le classeur "ae:31" et on va tomber sur la vmnic et sur l'esxi.</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div>OU BIEN&nbsp;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><ol style="margin-top: 5px; margin-right: 0px; margin-left: 20px; padding: 10px; list-style-position: initial; list-style-image: initial; overflow-wrap: break-word; font-size: 12px;"><li><div style="overflow: auto;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">Determine which host has created the lock by comparing the MAC address from the output of&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;">vmkfstools</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">&nbsp;with the MAC address from the management interface of all other ESX or ESXi hosts.</span></span></div></li><ul style="margin-right: 0px; margin-left: 20px; padding: 10px; list-style: disc; overflow-wrap: break-word;"><li><div style="overflow: auto;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">ESX/ESXi lists the MAC address of the service console interface with the commands:</span></span></div></li><ul style="margin-right: 0px; margin-left: 20px; padding: 10px; list-style: disc; overflow-wrap: break-word;"><li><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;"># esxcfg-info -y | grep "System UUID"</span></span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">For example:</span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;"># esxcfg-info -y | grep "System UUID"</span></span></span></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;">|----System UUID.................................................4b97b79b-dda7-eede-</span><font face="Courier New"><span style="font-size: 10pt; color: rgb(255, 0, 0);">0017a446ae31</span></font></span></span></div></li><li><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;"># grep uuid /etc/vmware/esx.conf</span></span></span></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">For example</span></span><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">:</span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;"># grep uuid /etc/vmware/esx.conf</span></span></span></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;">/system/uuid = "4b97b79b-dda7-eede-617f-<span style="font-size: 10pt; color: rgb(255, 0, 0);">0017a446ae31</span></span></span></span></div></li></ul><li><div style="overflow: auto;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">For ESX and VMware Infrastructure (VI) Client, select the host and click&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">Configuration</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">&nbsp;tab &gt;&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">Networking</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">&nbsp;&gt;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">Properties...</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">&nbsp;&gt;&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">Ports</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">&nbsp;tab &gt;&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">Service Console</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">. The</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">MAC address is on the right.</span></span></div></li><li><div style="overflow: auto;"><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">For ESXi and VI Client, select the host and click&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">Configuration</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">&nbsp;tab &gt;&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">Networking</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">&nbsp;&gt;&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">Properties...</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">&nbsp;&gt;&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">Ports</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">&nbsp;tab &gt;&nbsp;</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial; font-weight: 700;">Management Network</span><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">. The MAC address is on the right.</span></span></span></span></div></li><li><div style="overflow: auto;"><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">For verifying if the existing NICs having the lock and need to find out the MAC address of the NICs use:</span></span></span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;"># esxcfg-nics -l | grep -i "xx:xx:</span></span></span><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;">xx:<span style="font-size: 10pt; color: rgb(255, 0, 0); font-weight: bold;">xx</span></span></span></span><span style="font-size: 10pt; color: rgb(255, 0, 0); font-family: Arial; font-weight: bold;">&nbsp;<span style="font-size: 10pt;"><span style="font-size: 10pt; font-family: &quot;Courier New&quot;;">:xx:xx</span></span></span><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;">"</span></span></span></div></div></li></ul><li><div style="overflow: auto;"><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: Arial;">Run this command to verify that there are no virtual machines that could be using the file in question:</span></span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;;"># find -H /vmfs/volumes/*/*/*.vmx -print0 | xargs -0 grep "</span><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: italic;">filename</span><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;;">"</span></span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: Arial; font-weight: 700;">Note</span><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: Arial;">: In ESXi remove the option "-H". Doing so you would get 2 lines for every resulting vmx. One with the Datastore easy name and another with the Datastore UUID.</span></span></span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: Arial;">For e</span></span></span></span><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: Arial;">xample:</span></span></span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt;"><font face="Arial"><span style="font-size: 10pt; font-family: &quot;Courier New&quot;; color: rgb(0, 0, 0);"># find /vmfs/volumes/*/*/*.vmx -print0 | xargs -0 grep "ag-test.vmdk"</span></font></span></span></span></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt;"><font face="Arial"><span style="font-size: 10pt; font-family: &quot;Courier New&quot;; color: rgb(0, 0, 0);">/vmfs/volumes/7e2d0213-7530bdba/ag-test/ag-test.vmx:scsi0:0.fileName = "ag-test.vmdk"</span></font></span></span></span></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt;"><font face="Arial"><span style="font-size: 10pt; font-family: &quot;Courier New&quot;; color: rgb(0, 0, 0);">/vmfs/volumes/dc03-nfs/ag-test/ag-test.vmx:scsi0:0.fileName = "ag-test.vmdk"</span></font></span></span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: Arial;">This lists all instances of&nbsp;</span><em><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;;">filename</span></em><span style="font-size: 10pt; color: rgb(0, 0, 0); font-family: Arial;">&nbsp;within the configuration files of all virtual machines on all the Datastores.</span></span></span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div></div></li><li><div style="overflow: auto;"><div><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">For ESX hosts, run the following command to verify that there are no service console processes accessing the file:</span></span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-size: 10pt;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: &quot;Courier New&quot;;">lsof | grep -i&nbsp;<span style="font-size: 10pt; font-style: italic;">filename</span></span></span></span></div></div></li><li><div style="overflow: auto;"><span style="font-size: 10pt;"><span style="font-size: 10pt; color: rgba(77, 76, 76, 0.9); font-family: Arial;">Verify that all processes accessing the file complete or are stopped.</span></span></div></li></ol></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div><span style="font-weight: bold;">DANS LA KB ENSUITE IL DISENT DE REBOOTER L'ESX ou la VM :</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></div><div>Perso, jusqu'à présent, une fois que j'avais le nom de l'ESXi, je redémarre ses services et ça a toujours délocké :&nbsp; Voir note -&gt; Restart management agent ESXi</div>