<div><div align="left" style="min-height: 12pt;"><span style="font-size: 14pt;">Vérification et voir les stratum etc. :</span>&nbsp;<br></div><div align="left" style="min-height: 11pt;"><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">ntpq -p</div></div><div>&nbsp;<br></div><div>st : stratum -&gt; 1 = signal fort de synchro type gps etc. 2 = très bien. 16 = maximum KO</div><div>refid : si on a l'ip c'est que c'est bien synchronisé sinon on à .INIT. (initialisation) ce qui signifie qu'il n'arrive pas à synchroniser. L'ip est celui sur lequel il est synchronisé par forcément le serveur NTP. Par exemple là le serveur NTP est un 172.XX.XX.141 et lui doit se synchroniser sur le 10.XXX.0.2 qui peut par exemple être un équipement GPS.</div><div>&nbsp;<br></div><div>Un qui fonctionne :</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div># ntpq -p</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: rgb(255, 250, 165);">st</span> t when poll reach&nbsp;&nbsp;&nbsp;delay&nbsp;&nbsp;&nbsp;offset&nbsp;&nbsp;jitter</div><div>==============================================================================</div><div><span style="background-color: rgb(255, 250, 165);">*</span>172.XX.XX.141&nbsp;&nbsp;<span style="background-color: rgb(255, 250, 165);">10.XXX.0.2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: rgb(255, 250, 165);">2</span> u&nbsp;&nbsp;156 1024&nbsp;&nbsp;377&nbsp;&nbsp;&nbsp;&nbsp;1.656&nbsp;&nbsp;&nbsp;&nbsp;0.212&nbsp;&nbsp;&nbsp;0.223</div><div>LOCAL(0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.LOCL.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10 l&nbsp;&nbsp;15d&nbsp;&nbsp;&nbsp;64&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;0.000&nbsp;&nbsp;&nbsp;&nbsp;0.000&nbsp;&nbsp;&nbsp;0.000</div></div><div>&nbsp;<br></div><div>Un qui ne fonctionne pas :</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div># ntpq -p</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: rgb(255, 250, 165);">st</span> t when poll reach&nbsp;&nbsp;&nbsp;delay&nbsp;&nbsp;&nbsp;offset&nbsp;&nbsp;jitter</div><div>==============================================================================</div><div>172.29.153.141&nbsp;&nbsp;<span style="background-color: rgb(255, 250, 165);">.INIT.&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: rgb(255, 250, 165);">16</span> u&nbsp;&nbsp;&nbsp;&nbsp;- 1024&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;0.000&nbsp;&nbsp;&nbsp;&nbsp;0.000&nbsp;&nbsp;&nbsp;0.000</div><div><span style="background-color: rgb(255, 250, 165);">*</span>LOCAL(0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.LOCL.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10 l&nbsp;&nbsp;&nbsp;16&nbsp;&nbsp;&nbsp;64&nbsp;&nbsp;377&nbsp;&nbsp;&nbsp;&nbsp;0.000&nbsp;&nbsp;&nbsp;&nbsp;0.000&nbsp;&nbsp;&nbsp;0.000</div></div><div>&nbsp;<br></div><div>On ne peut pas tester si le port répond (flux fermé ou ouvert) car c'est de l'UDP et pas du TCP (port 23). Demander au réseau si le flux est ouvert.</div><div>&nbsp;<br></div><div>Pour vérifier aussi :</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">ntpstat</div><div>&nbsp;<br></div><hr><div>&nbsp;<br></div></div><div><font size="5"><b>CAS&nbsp;</b></font></div><div>&nbsp;<br></div><div><font size="3">CAS 1</font></div><div>&nbsp;<br></div><div>Pas de synchro (voir réponse ntpq ci-dessus).</div><div>Il manquait une route de host vers la pate d'admin du serveur. Le flux ntp sortait par la pate de service qui ensuite est bloqué par l'équipement réseau. Le ntp n'est pas bloqué par le réseau sur la pate d'admin.</div><div>&nbsp;<br></div><div><font size="3">CAS 2</font></div><div>&nbsp;<br></div><div><span style="font-size: 10pt;">Juste relance du service mais il a fallu attendre au moins 5 minutes pour qu'il se resynchronise bien et vérifier avec ntpq -p</span></div><div>&nbsp;<br></div><div><font size="3">CAS 3</font></div><div><span style="font-size: 14pt;">&nbsp;<br></span></div><div><span style="font-size: 10pt;">Pas de synchro.</span></div><div><span style="font-size: 10pt;">Le serveur NTP n'était pas le bon. La politique ici veut que l'on synchronize sur la passerelle de la patte d'admin donc remplacer dans le ntp.conf le ntp serveur par la passerelle de l'admin puis restart du ntp (mais ne suffit pas à synchroniser car l'étoile reste sur le LOCAL dans ntpq -p) + "</span>ntpd -gq" pour reforcer la synchro.</div><div>&nbsp;<br></div><div><font size="3">CAS 4</font></div><div><font style="font-size: 14pt;">&nbsp;<br></font></div><div><span style="font-size: 10pt;">Sur une infra particulière parfois il y a un décalage. Voici ce que l'on faisait (Redhat 6.1) :</span></div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div># Copie de la version antérieure</div><div>cp /etc/ntp.conf /etc/20140515_ntp.conf</div><div>&nbsp;<br></div><div># Mise a l heure</div><div>/etc/init.d/ntpd stop</div><div>ntpdate -u 172.XX.XX.XX</div><div>vi /etc/ntp.conf</div><div>server 172.XX.XX.XX prefer&nbsp;&nbsp;&nbsp;&nbsp;&lt;------ Vérifier que cette ligne apparait</div><div>&nbsp;<br></div><div># Relance ntp et mise a jour de l'horloge hard</div><div>/etc/init.d/ntpd restart</div><div>/sbin/hwclock --show (affiche l'heure hardware)</div><div>/sbin/hwclock --systohc&nbsp;&nbsp;&nbsp;--&gt; resynchronise</div><div>/sbin/hwclock --show (pour comparaison)</div><div>&nbsp;<br></div><div>#vérification</div><div>ntpq -p</div></div><div>&nbsp;<br></div><div>&nbsp;<br><hr></div><div>&nbsp;<br></div><div>Exemple :</div><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@~]# date</div><div>mer. aout 21 15:48:14 CEST 2019</div><div>&nbsp;<br></div><div>[root@~]# /etc/init.d/ntpd stop</div><div>Arret de ntpd :&nbsp;&nbsp;&nbsp;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;&nbsp;OK&nbsp;&nbsp;]</div><div>[root@~]# ntpdate -u&nbsp;172.XX.XX.XX</div><div>21 Aug 15:56:46 ntpdate[10241]: step time server 172.XX.XX.XX offset 495.488326 sec</div><div>&nbsp;<br></div><div>[root@~]# vi /etc/ntp.conf</div><div>&nbsp;<br></div><div>[root@~]# /etc/init.d/ntpd restart</div><div>Arret de ntpd :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ECHOUE]</div><div>Demarrage de ntpd :&nbsp;&nbsp;&nbsp;&nbsp;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;&nbsp;OK&nbsp;&nbsp;]</div><div>[root@~]# /sbin/hwclock --show</div><div>mer. 21 aout 2019 15:57:14 CEST&nbsp;&nbsp;-0.925193 secondes</div><div>&nbsp;<br></div><div>[root@~]# /sbin/hwclock --systohc</div><div>[root@~]# /sbin/hwclock --show</div><div>&nbsp;<br></div><div>mer. 21 aout 2019 15:57:28 CEST&nbsp;&nbsp;-0.914358 secondes</div><div>&nbsp;<br></div><div>[root@~]# ntpq -p</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;st t when poll reach&nbsp;&nbsp;&nbsp;delay&nbsp;&nbsp;&nbsp;offset&nbsp;&nbsp;jitter</div><div>==============================================================================</div><div>SERVER-NTP 172.XX.XX.XX&nbsp;&nbsp;&nbsp;3 u&nbsp;&nbsp;&nbsp;25&nbsp;&nbsp;&nbsp;64&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;1.170&nbsp;&nbsp;&nbsp;&nbsp;4.198&nbsp;&nbsp;&nbsp;0.000</div><div>LOCAL(0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.LOCL.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10 l&nbsp;&nbsp;&nbsp;24&nbsp;&nbsp;&nbsp;64&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;0.000&nbsp;&nbsp;&nbsp;&nbsp;0.000&nbsp;&nbsp;&nbsp;0.000</div><div>&nbsp;<br></div><div>[root@~]# date</div><div>mer. aout 21 15:57:58 CEST 2019</div></div><div>&nbsp;<br></div><div style="min-height: 12pt;"><div><span style="font-size: 21px; font-weight: bold;">&nbsp;<br></span></div><div><span style="font-size: 21px; font-weight: bold;">ntp offset important</span></div><div>&nbsp;<br></div><div><span style="font-weight: bold;">Redhat 6</span></div><div>&nbsp;<br></div></div><div style="min-height: 11pt;"><span style="font-size: 9pt;">Copie de la version antérieure :</span></div><div style="min-height: 11pt;"><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">cp /etc/ntp.conf /etc/20140515_ntp.conf</div><div>&nbsp;<br></div></div><div style="min-height: 11pt;"><div><span style="font-size: 9pt;">Mise à l'heure en synchronisant avec le serveur NTP XXX.XXX.XXX.XXX :</span></div><div>&nbsp;<br></div></div><div style="min-height: 11pt;"><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>/etc/init.d/ntpd stop</div><div>ntpdate -u XXX.XXX.XXX.XXX</div></div><div>&nbsp;<br></div></div><div style="min-height: 11pt;">Edition du fichier de conf pour rajouter le serveur ntp :</div><div style="min-height: 11pt;"><div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>vi /etc/ntp.conf</div><div>server 172.30.5.58 <span style="font-weight: bold;">prefer</span></div></div><div>&nbsp;<br></div></div><div style="min-height: 11pt;"><div><span style="font-size: 9pt;">Relance ntp et mise a jour de l'horloge hard :</span></div><div>&nbsp;<br></div></div><div style="min-height: 11pt;"><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>/etc/init.d/ntpd restart</div><div>/sbin/hwclock --show (affiche l'heure hardware)</div><div>/sbin/hwclock --systohc</div><div>/sbin/hwclock --show (pour comparaison)</div></div></div><div>&nbsp;<br></div><div>&nbsp;<br></div>