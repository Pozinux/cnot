<div>Linux security modules (LSM) intégrés au noyau depuis la version 2.6. API utilisée par SELinux mais aussi AppArmor (sous Ubuntu par exemple).</div><div>&nbsp;&nbsp;<br></div><div>SELINUX --&gt; Défini quel fichier peut-être accédé par quel process</div><div>&nbsp;&nbsp;<br></div><div><span style="font-weight: bold;">Mode Enforcing</span> : Ne laisse rien passer par défaut / à nous de créer les policy pour laisser passer ou non</div><div><span style="font-weight: bold;">Mode Permissive</span> : Laisse tout passer par défaut mais log tout ce qui se passe dans /var/log/audit/audit.log. Si SELinux est dans ce mode et que quelque chose est bloqué, le pbm ne vient pas de SELinux donc c'est mieux de le mettre comme ça qu'en mode Disabled.</div><div>&nbsp;&nbsp;<br></div><div>Les données d'un context (par exemple contexte http ou context home) ne peuvent pas être accédées par les process d'un autre contexte ou alors il faut les labéliser aussi pour ce contexte.</div><div>&nbsp;&nbsp;<br></div><div>Lister le contexte SElinux :</div><div>&nbsp;&nbsp;<br></div><div>Note : le <span style="background-color: rgb(255, 255, 0);">"."</span> à la fin des permissions signifie que ce fichier a un context SELINUX</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos2 ~]# ls -Z</div><div>-rw-r--r--<span style="background-color: rgb(255, 250, 165);"><b><font color="#FF0000">.</font></b></span> root root&nbsp; &nbsp;<span style="background-color: rgb(255, 250, 165);">system_u:object_r:<span style="color: rgb(227, 0, 0);"><b>admin_home_t</b></span>:s0</span> acl.backup</div><div>...</div></div><div>&nbsp;&nbsp;<br></div><div><span style="font-weight: bold;">Légende des contextes</span> ---&gt; user : role : type : sensitivity</div><div>&nbsp;&nbsp;<br></div><div>La policy peut-être "targeted" ou "minimum" ou "mls" (voir /etc/selinux/config). Par défaut elle est "targeted" = policy qui base ses règles sur le 3ième contexte câd "type context" (fini avec <span style="background-color: rgb(255, 250, 165); color: rgb(255, 0, 0); font-weight: bold;">_t</span>). Par exemple pour les serveurs web c'est "httpd_sys_content_t". Pour les fichiers et répertoires se trouvant dans /var/www/html le contexte sera "httpd_sys_content_t". Pour les ports serveur web : http_port_t.</div><div>Le serveur web ne pourra donc pas accèder aux fichiers dans /tmp alors que sans SELinux il pourrait (pbm de sécurité).</div><div>&nbsp;&nbsp;<br></div><div>Le contexte par défaut d'un fichier lorsqu'il est créé dépend du contexte de son répertoire parent.</div><div>Si un fichier est créé ailleurs (mv, cp etc.) son contexte est préservé.</div><div>&nbsp;&nbsp;<br></div><div>On peut aussi voir le context d'un process (par exemple sshd) :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos2 ~]# ps fauxZ | grep sshd</div><div>system_u:system_r:<span style="background-color: rgb(255, 250, 165);">sshd_t</span>:s0-s0:c0.c1023 root 930 0.0&nbsp; 0.4 105996 4068 ?&nbsp; &nbsp; &nbsp; &nbsp; Ss&nbsp; &nbsp;10:29&nbsp; &nbsp;0:00 /usr/sbin/sshd -D</div></div><div>&nbsp;&nbsp;<br></div><div>Même chose pour les ports :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">u_str&nbsp; ESTAB&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp;* 17177&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 17178&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;users:(("sshd",pid=930,proc_ctx=system_u:system_r:<span style="background-color: rgb(255, 250, 165);">sshd_t</span>:s0-s0:c0.c1023,fd=2),("sshd",pid=930,proc_ctx=system_u:system_r:sshd_t:s0-s0:c0.c1023,fd=1))</div><div>&nbsp;&nbsp;<br></div><div>&nbsp;&nbsp;<br></div><div><span style="text-decoration-line: underline;">SELinux Booleans</span></div><div>&nbsp;&nbsp;<br></div><div>SELinux Booleans sont des switchs là pour définir le comportement (activer ou désactiver une fonction) des policy SELinux.</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos2 ~]# getsebool -a</div><div>abrt_anon_write --&gt; off</div><div>abrt_handle_event --&gt; off</div><div>abrt_upload_watch_anon_write --&gt; on</div><div>antivirus_can_scan_system --&gt; off</div><div>antivirus_use_jit --&gt; off</div><div>...</div></div><div>&nbsp;&nbsp;<br></div><div>setsebool <span style="background-color: rgb(255, 250, 165);">-P</span> &nbsp;---&gt; modifie en persistent</div><div>semanage boolean -l ----&gt; montre si le booleen est persistant ou pas + une petite description &nbsp;/ &nbsp; Affiche (on , off) ce qui signifie (état actuel, état par défaut)</div><div>semanage boolean -l -C &nbsp; ----&gt; liste local modifications (tout ce qui diffère des policy par défaut)&nbsp;</div><div>setsebool BOOLEAN_NAME on &nbsp; / &nbsp;setsebool BOOLEAN_NAME off</div><div>getsebool BOLLEAN_NAME ---&gt; voir son état</div><div>&nbsp;&nbsp;<br></div><div>&nbsp;&nbsp;<br></div><div><span style="text-decoration-line: underline;">Changer le contexte d'un fichier :</span></div><div>&nbsp;&nbsp;<br></div><div>- chcon : on spécifie le contexte manuellement. Si le système est relabelisé au boot, ce contexte est remis par défaut. On utilise souvent seulement "-t" pour définir le type du contexte.</div><div>- restorecon (<span style="color: rgb(255, 0, 0);">méthode prefered - fait partie du package policycoreutil</span>) : on ne spécifie pas manuellement, le contexte du fichier est défini suivant des régles des policy SELinux en place.</div><div>&nbsp;&nbsp;<br></div><div><span style="text-decoration-line: underline;">Définir la régle de context par défaut d'un fichier :</span></div><div>&nbsp;&nbsp;<br></div><div>----&gt; Cas concret :&nbsp; <a href="https://www.evernote.com/shard/s72/nl/8374248/710bb05f-f1d2-4329-a74f-7dbb7c062635" style="color: rgb(105, 170, 53);">Linux Troubleshooting – semanage command not found in CentOS 7/RHEL 7</a></div><div>&nbsp;&nbsp;<br></div><div>La commande "semanage fcontext" permet d'afficher ou modifier les règles que la commande "restorecon" utilise pour setter par les contextes par défaut des fichiers. &nbsp;</div><div>&nbsp;&nbsp;<br></div><div>Cette commande n'est pas toujours installée, il faut installer le package "policycoreutils-python" (ou faire un yum provides semanage pour le trouver).</div><div>&nbsp;&nbsp;<br></div><div>Note : L'expression régulière la plus utilisée est (/.*)? &nbsp;-----&gt; signifie match un "/" suivi de n'importe quel nombre de caractères. Match le répertoire listé avant la regex et tout dans ce répertoire récurssivement.&nbsp;</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div><span style="font-size: 11px;">[root@centos2 ~]# semanage fcontext -l | more</span></div><div><span style="font-size: 11px;">SELinux fcontext&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;type&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Context</span></div><div><span style="font-size: 11px;">&nbsp;&nbsp;<br></span></div><div><span style="font-size: 11px;">/.*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all files&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; system_u:object_r:default_t:s0</span></div><div><span style="font-size: 11px;">/[^/]+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;regular file&nbsp; &nbsp; &nbsp; &nbsp;system_u:object_r:etc_runtime_t:s0</span></div><div><span style="font-size: 11px;">/a?quota\.(user|group)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;regular file&nbsp; &nbsp; &nbsp; &nbsp;system_u:object_r:quota_db_t:s0</span></div><div><span style="font-size: 11px;">/nsr<b><span style="color: rgb(255, 0, 0);"><span style="background-color: rgb(255, 250, 165);">(/.*)?</span></span></b>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;all files&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; system_u:object_r:var_t:s0</span></div><div><span style="font-size: 11px;">/sys(/.*)?&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;all files&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; system_u:object_r:sysfs_t:s0</span></div><div><span style="font-size: 11px;">/xen(/.*)?&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;all files&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; system_u:object_r:xen_image_t:s0</span></div><div><span style="font-size: 11px;">/mnt(/[^/]*)?&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; directory&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; system_u:object_r:mnt_t:s0</span></div><div><span style="font-size: 11px;">/mnt(/[^/]*)?&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; symbolic link&nbsp; &nbsp; &nbsp; system_u:object_r:mnt_t:s0</span></div><div><span style="font-size: 11px;">/bin/.*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all files&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; system_u:object_r:bin_t:s0</span></div><div><span style="font-size: 11px;">/dev/.*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all files&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; system_u:object_r:device_t:s0</span></div><div><span style="font-size: 11px;">/usr/.*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all files&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; system_u:object_r:usr_t:s0</span></div><div><span style="font-size: 11px;">/var/.*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all files&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; system_u:object_r:var_t:s0</span></div><div>..........</div></div><div>&nbsp;&nbsp;<br></div><div>On peut ajouter (-a) ou supprimer (-d) un contexte avec semanage fcontext :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div># semanage fcontext -a -t http_sys_content_t '/rep1(/.*)?'</div><div>&nbsp;&nbsp;<br></div><div>puis</div><div>&nbsp;&nbsp;<br></div><div># restorecon -RFvv /rep1</div></div><div>&nbsp;&nbsp;<br></div><div>&nbsp;&nbsp;<br></div><div><span style="font-weight: bold; text-decoration-line: underline;">CAS CONCRET : Interprêter les logs de SELinux, créer une règle de context et l'appliquer :</span></div><div>&nbsp;&nbsp;<br></div><div>Par exemple, ci-dessous, je vois que SELinux a bloqué http de lire le site web que j'avais configuré dans /custom au lieu de /var/www/html car ce process n'est pas censé lire ce fichier index dans ce répertoire.</div><div>&nbsp;&nbsp;<br></div><div><img src="data:image/png;base64,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" style="height: auto;"></div><div>&nbsp;&nbsp;<br></div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos2 /]#&nbsp;yum install setroubleshoot-server</div><div>&nbsp;&nbsp;<br></div><div>[root@centos2 /]# sealert -a /var/log/audit/audit.log | more</div><div>&nbsp;&nbsp;<br></div><div>found 2 alerts in /var/log/audit/audit.log</div><div>--------------------------------------------------------------------------------</div><div>&nbsp;&nbsp;<br></div><div>SELinux is preventing /usr/sbin/ip from read access on the file /run/vmware-active-nics.</div><div>&nbsp;&nbsp;<br></div><div>*****&nbsp; Plugin restorecon (99.5 confidence) suggests&nbsp; &nbsp;************************</div><div>&nbsp;&nbsp;<br></div><div>SELinux is preventing /usr/sbin/httpd from getattr access on the file /custom/index.html.</div><div>.....</div></div><div>&nbsp;</div><div>Attention ! Installer le package "setroubleshoot-server" fait que les logs SELinux se trouvent dans /var/log/messages (en plus de /var/log/audit.log) :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">Jan 12 22:15:18 centos2 setroubleshoot: SELinux is preventing httpd from getattr access on the file /custom/index.html. For complete SELinux messages run: <span style="background-color: rgb(255, 250, 165);">sealert -l d31b1396-2f8b-4153-8978-b4de709714b1</span></div><div>&nbsp;&nbsp;<br></div><div>On peut aussi utiliser sealert avec l'UUID&nbsp;de la violation SELinux (qui se trouve dans /var/log/messages) :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">[root@centos2 ~]# sealert -l d31b1396-2f8b-4153-8978-b4de709714b1</span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">SELinux is preventing httpd from getattr access on the file /custom/index.html.</span></span></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">*****&nbsp; Plugin catchall_labels (83.8 confidence) suggests&nbsp; &nbsp;*******************</span></span></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">If you want to allow httpd to have getattr access on the index.html file</span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">Then you need to change the label on /custom/index.html</span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">Do</span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;"># semanage fcontext -a -t FILE_TYPE '/custom/index.html'</span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">where FILE_TYPE is one of the following: NetworkManager_exec_t, NetworkManager_log_t, NetworkManager_tmp_t, abrt_dump_oops_exec_t, abrt_etc_t, abrt_exec_t, abrt_handle_event_exec_t, abrt_helper_exec_t, abrt_retrace_coredump_exec_t, abrt_retrace_spool_t, abrt_retrace_worker_exec_t, abrt_tmp_t, abrt_upload_watch_tmp_t, abrt_var_cache_t, abrt_var_log_t, abrt_var_run_t, accountsd_exec_t, acct_data_t, acct_exec_t, admin_crontab_tmp_t, admin_passwd_exec_t, afs_logfile_t, aide_exec_t, aide_log_t, alsa_exec_t, alsa_tmp_t, amanda_exec_t, amanda_l</span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">....</span></span></div><div>&nbsp;&nbsp;<br></div><div><span style="background-color: rgb(255, 250, 165);"><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">Raw Audit Messages</span></span></span></div><div><span style="font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">type=AVC msg=audit(1515791699.881:259): avc:&nbsp; denied&nbsp; { getattr } for&nbsp; pid=3071 comm="</span><span style="background-color: rgb(255, 250, 165); font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">httpd</span><span style="font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">" path="</span><span style="background-color: rgb(255, 250, 165); font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">/custom/index.html</span><span style="font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">" dev="sda3" ino=67565321</span> <span style="background-color: rgb(255, 250, 165); font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">scontext</span><span style="font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">=system_u:system_r:</span><span style="background-color: rgb(255, 250, 165); font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">httpd_t</span><span style="font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">:s0</span> <span style="background-color: rgb(255, 250, 165); font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">tcontext</span><span style="font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">=unconfined_u:object_r:</span><span style="background-color: rgb(255, 250, 165); font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">default_t</span><span style="font-size: 12px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">:s0 tclass=file</span></div><div>&nbsp;&nbsp;<br></div></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">A la fin on a le "Raw Audit Message" qui donne :</span></span></div><div>&nbsp;&nbsp;<br></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">- Le process concerné</span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">- Le chemin + fichier concerné</span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">- scontext : le context "s"ource</span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;">- tcontext : le context "t"arget</span></span></div><div>&nbsp;&nbsp;<br></div><div>&nbsp;&nbsp;<br></div><div>Il&nbsp;me faut donc créer une règle de contexte pour modifier /custom + tous les répertoires et fichiers dessous pour qu'ils soient exécutables de httpd.</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);">[root@centos2 /]# semanage fcontext -a -t httpd_sys_content_t '/custom(/.*)?'</div><div>&nbsp;&nbsp;<br></div><div>Une fois la règle de contexte créée, tant que je ne l'ai pas appliquée, les fichiers gardent leurs context :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos2 /]# ll -Z custom/index.html</div><div>-rw-r--r--. root root unconfined_u:object_r:<span style="background-color: rgb(255, 250, 165);">default_t</span>:s0 <span style="background-color: rgb(255, 250, 165);">custom/index.html</span></div></div><div>&nbsp;&nbsp;<br></div><div>Je demande à SELinux d'appliquer la règle concernant /custom :</div><div>&nbsp;&nbsp;<br></div><div>- R : recursif</div><div>- v : afficher les changements</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos2 /]# restorecon -Rv /custom/</div><div>restorecon reset /custom context unconfined_u:object_r:default_t:s0-&gt;unconfined_u:object_r:httpd_sys_content_t:s0</div><div>restorecon reset /custom/index.html context unconfined_u:object_r:default_t:s0-&gt;unconfined_u:object_r:httpd_sys_content_t:s0</div></div><div>&nbsp;&nbsp;<br></div><div>Le context du fichier a changé, la page web peut s'afficher :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos2 /]# ll -Z custom/index.html</div><div>-rw-r--r--. root root unconfined_u:object_r:<span style="background-color: rgb(255, 250, 165);">httpd_sys_content_t</span>:s0 custom/index.html</div></div><div>&nbsp;&nbsp;<br></div><div>Supprimer la règle dernièrement créée et remettre les droits comme avant :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos2 ~]# semanage fcontext -d '/custom(/.*)?'</div><div>&nbsp;&nbsp;<br></div><div>[root@centos2 ~]# restorecon -Rv /custom/</div><div>restorecon reset /custom context system_u:object_r:httpd_sys_content_t:s0-&gt;system_u:object_r:default_t:s0</div><div>restorecon reset /custom/index.html context unconfined_u:object_r:httpd_sys_content_t:s0-&gt;unconfined_u:object_r:default_t:s0</div></div><div>&nbsp;&nbsp;<br></div><div>Avec semanage, on peut gérer autre chose que les context de fichiers (fcontext). Par exemple les ports :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos2 ~]# semanage port -l | grep ssh</div><div>ssh_port_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; &nbsp; &nbsp; <span style="background-color: rgb(255, 250, 165);">22</span></div></div><div>&nbsp;&nbsp;<br></div><div>On voit que SELinux vérifie que SSh écoute bien sur le port 22.</div><div>&nbsp;&nbsp;<br></div><div>Si on voulait donc un autre port (par exemple 8888), il faut modifier le fichier sshd_config mais aussi rajouter une règle :</div><div>&nbsp;&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>[root@centos2 ~]# semanage port -a -t ssh_port_t -p tcp 8888</div><div>&nbsp;&nbsp;<br></div><div>[root@centos2 ~]# semanage port -l | grep ssh</div><div>ssh_port_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; &nbsp; &nbsp; <span style="background-color: rgb(255, 250, 165);">8888</span>, 22</div><div>&nbsp;&nbsp;<br></div></div><div>&nbsp;&nbsp;<br></div>