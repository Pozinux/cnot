<div>&nbsp;<br></div><div style="padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);"><div>#!/bin/bash</div><div>#</div><div># hugepages_settings.sh</div><div>#</div><div># Linux bash script to compute values for the</div><div># recommended HugePages/HugeTLB configuration</div><div># on Oracle Linux</div><div>#</div><div># Note: This script does calculation for all shared memory</div><div># segments available when the script is run, no matter it</div><div># is an Oracle RDBMS shared memory segment or not.</div><div>#</div><div># This script is provided by Doc ID 401749.1 from My Oracle Support</div><div># http://support.oracle.com</div><div>&nbsp;<br></div><div># Welcome text</div><div>echo "</div><div>This script is provided by Doc ID 401749.1 from My Oracle Support</div><div>(http://support.oracle.com) where it is intended to compute values for</div><div>the recommended HugePages/HugeTLB configuration for the current shared</div><div>memory segments on Oracle Linux. Before proceeding with the execution please note following:</div><div>* For ASM instance, it needs to configure ASMM instead of AMM.</div><div>* The 'pga_aggregate_target' is outside the SGA and</div><div>&nbsp;&nbsp;&nbsp;you should accommodate this while calculating the overall size.</div><div>* In case you changes the DB SGA size,</div><div>&nbsp;&nbsp;&nbsp;as the new SGA will not fit in the previous HugePages configuration,</div><div>&nbsp;&nbsp;&nbsp;it had better disable the whole HugePages,</div><div>&nbsp;&nbsp;&nbsp;start the DB with new SGA size and run the script again.</div><div>And make sure that:</div><div>* Oracle Database instance(s) are up and running</div><div>* Oracle Database 11g Automatic Memory Management (AMM) is not setup</div><div>&nbsp;&nbsp;&nbsp;(See Doc ID 749851.1)</div><div>* The shared memory segments can be listed by command:</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# ipcs -m</div><div>&nbsp;<br></div><div>&nbsp;<br></div><div>Press Enter to proceed..."</div><div>&nbsp;<br></div><div>read</div><div>&nbsp;<br></div><div># Check for the kernel version</div><div>KERN=`uname -r | awk -F. '{ printf("%d.%d\n",$1,$2); }'`</div><div>&nbsp;<br></div><div># Find out the HugePage size</div><div>HPG_SZ=`grep Hugepagesize /proc/meminfo | awk '{print $2}'`</div><div>if [ -z "$HPG_SZ" ];then</div><div>&nbsp;&nbsp;&nbsp;&nbsp;echo "The hugepages may not be supported in the system where the script is being executed."</div><div>&nbsp;&nbsp;&nbsp;&nbsp;exit 1</div><div>fi</div><div>&nbsp;<br></div><div># Initialize the counter</div><div>NUM_PG=0</div><div>&nbsp;<br></div><div># Cumulative number of pages required to handle the running shared memory segments</div><div>for SEG_BYTES in `ipcs -m | cut -c44-300 | awk '{print $1}' | grep "[0-9][0-9]*"`</div><div>do</div><div>&nbsp;&nbsp;&nbsp;&nbsp;MIN_PG=`echo "$SEG_BYTES/($HPG_SZ*1024)" | bc -q`</div><div>&nbsp;&nbsp;&nbsp;&nbsp;if [ $MIN_PG -gt 0 ]; then</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUM_PG=`echo "$NUM_PG+$MIN_PG+1" | bc -q`</div><div>&nbsp;&nbsp;&nbsp;&nbsp;fi</div><div>done</div><div>&nbsp;<br></div><div>RES_BYTES=`echo "$NUM_PG * $HPG_SZ * 1024" | bc -q`</div><div>&nbsp;<br></div><div># An SGA less than 100MB does not make sense</div><div># Bail out if that is the case</div><div>if [ $RES_BYTES -lt 100000000 ]; then</div><div>&nbsp;&nbsp;&nbsp;&nbsp;echo "***********"</div><div>&nbsp;&nbsp;&nbsp;&nbsp;echo "** ERROR **"</div><div>&nbsp;&nbsp;&nbsp;&nbsp;echo "***********"</div><div>&nbsp;&nbsp;&nbsp;&nbsp;echo "Sorry! There are not enough total of shared memory segments allocated for</div><div>HugePages configuration. HugePages can only be used for shared memory segments</div><div>that you can list by command:</div><div>&nbsp;<br></div><div>&nbsp;&nbsp;&nbsp;&nbsp;# ipcs -m</div><div>&nbsp;<br></div><div>of a size that can match an Oracle Database SGA. Please make sure that:</div><div>* Oracle Database instance is up and running</div><div>* Oracle Database 11g Automatic Memory Management (AMM) is not configured"</div><div>&nbsp;&nbsp;&nbsp;&nbsp;exit 1</div><div>fi</div><div>&nbsp;<br></div><div># Finish with results</div><div>case $KERN in</div><div>&nbsp;&nbsp;&nbsp;&nbsp;'2.4') HUGETLB_POOL=`echo "$NUM_PG*$HPG_SZ/1024" | bc -q`;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo "Recommended setting: vm.hugetlb_pool = $HUGETLB_POOL" ;;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;'2.6') echo "Recommended setting: vm.nr_hugepages = $NUM_PG" ;;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;'3.8') echo "Recommended setting: vm.nr_hugepages = $NUM_PG" ;;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;'3.10') echo "Recommended setting: vm.nr_hugepages = $NUM_PG" ;;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;'4.1') echo "Recommended setting: vm.nr_hugepages = $NUM_PG" ;;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;'4.14') echo "Recommended setting: vm.nr_hugepages = $NUM_PG" ;;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;*) echo "Kernel version $KERN is not supported by this script (yet). Exiting." ;;</div><div>esac</div><div>&nbsp;<br></div><div># End</div></div><div>&nbsp;<br></div>